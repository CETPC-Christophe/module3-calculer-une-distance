<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOPOGRAPHIE - MODULE 3</title>
<style>
  :root {
    --orange:#ff6600;
    --noir:#222;
    --gris:#f3f3f3;
    --zoom-level: 1;
    --right-digit-offset: 5%;
    --right-digit-offset-px: 8px;
  }

  /* Responsive: plus d'espace sur mobile, un peu moins sur grands √©crans */
  @media (max-width: 640px), (pointer: coarse) {
    :root { --right-digit-offset: 6%; }
  }
  @media (min-width: 1280px) {
    :root { --right-digit-offset: 4%; }
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background-color: #f0f0f0;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    margin: 0;
    padding: 0;
  }

  .main-layout {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: clamp(1.5cm, 6vw, 3.5cm);
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    padding: clamp(0.5cm, 3vw, 1.5cm);
  }

  /* D√©calage suppl√©mentaire pour laisser respirer le viseur quand un panneau fixe est pr√©sent */
  @media (max-width: 1200px) {
    .main-layout {
      justify-content: flex-start;
      padding-right: calc(12cm + 4vw); /* espace r√©serv√© au panneau fixe */
    }
  }

  /* Tablette portrait : rapprocher les √©l√©ments */
  @media (max-width: 1024px) and (orientation: portrait) {
    .main-layout {
      gap: clamp(0.5cm, 2vw, 1.5cm);
      padding-right: calc(9cm + 2vw);
    }
  }

  /* Mobile : passer en colonne */
  @media (max-width: 768px) {
    .main-layout {
      flex-direction: column;
      height: auto;
      gap: clamp(0.5cm, 2vw, 1cm);
      padding-right: 0.5cm;
      padding-left: 0.5cm;
      padding-top: 0.5cm;
      padding-bottom: 0.5cm;
      justify-content: flex-start;
    }
  }

  .container {
    display: flex;
    gap: clamp(0.3cm, 1.5vw, 0.9cm);
    height: 100%;
    align-items: center;
    padding: clamp(0.5cm, 2vw, 1cm);
    position: relative; /* pour positionner le r√©ticule en overlay */
  }

  @media (max-width: 768px) {
    .container {
      height: auto;
      flex-direction: column;
      gap: 0.5cm;
      width: 100%;
    }
  }

  .mires-viewport {
    width: calc(clamp(0.9cm, 6vw, 1.8cm) * var(--zoom-level));
    height: 100%;
    overflow: hidden;
    position: relative;
    border: 2px solid #333;
    background-color: white;
    padding: 0 0.5cm; /* marge blanche r√©duite (0,5 cm de chaque c√¥t√©) */
  }

  @media (max-width: 768px) {
    .mires-viewport {
      width: calc(clamp(0.9cm, 6vw, 1.8cm) * var(--zoom-level));
      height: clamp(8cm, 40vh, 12cm);
    }
  }

  .mires-wrapper {
    display: flex;
    flex-direction: column;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    gap: 0;
    cursor: grab;
    user-select: none;
  }

  .mires-wrapper.dragging {
    cursor: grabbing;
  }

  .mire {
    display: flex;
    flex-direction: column-reverse;
    position: relative;
    gap: 0;
  }

  .line-container {
    display: flex;
    width: calc(clamp(0.9cm, 6vw, 1.8cm) * var(--zoom-level));
    height: calc(clamp(0.2cm, 1.5vw, 0.45cm) * var(--zoom-level));
  }

  .line-container.first-line {
    border-bottom: 2px solid black;
  }

  /* Trait horizontal rouge pour les mires rouges */
  .mire.red-group .line-container.first-line {
    border-bottom: 2px solid red;
  }

  .square {
    flex: 1;
    height: calc(clamp(0.2cm, 1.5vw, 0.45cm) * var(--zoom-level));
  }

  .red { background-color: red; }
  .black { background-color: black; }
  .white { background-color: white; }

  .trait-noir {
    display: none;
  }

  .chiffre {
    position: absolute;
    font-size: calc(clamp(0.2cm, 1vw, 0.4cm) * var(--zoom-level));
    font-weight: bold;
    color: black;
    transform: scaleX(2) scaleY(8);
    transform-origin: left bottom;
  }

  .chiffre.red {
    color: red;
    background-color: transparent;
    padding: 0;
    border-radius: 0;
  }

  .reticule {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 5;
    width: clamp(6cm, 50vw, 12cm);
    height: auto;
  }

  .reading-value {
    position: fixed;
    left: clamp(1cm, 7vw, 2cm);
    top: 50%;
    transform: translateY(-50%);
    font-size: clamp(11px, 2.5vw, 22px);
    font-weight: bold;
    color: black;
    z-index: 100;
    min-width: 150px;
    text-align: left;
  }
  /* Bloc multi-lectures (haut/milieu/bas) */
  .reading-values {
    position: fixed;
    right: 20px;
    bottom: 20px;
    left: auto;
    top: auto;
    transform: none;
    z-index: 100;
    background: rgba(255,255,255,0.9);
    border: 2px solid #333;
    border-radius: 10px;
    padding: 10px 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    min-width: 220px;
    font-size: clamp(11px, 2.2vw, 20px);
    display: none; /* cach√© sur demande */
  }
  .reading-item { display: flex; justify-content: space-between; margin: 4px 0; }
  .reading-label { color: #444; font-weight: 600; }
  .reading-mm { color: #000; font-weight: 700; }

  .zoom-controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: none; /* Masquer les contr√¥les de zoom */
    gap: 10px;
    z-index: 101;
  }

  .zoom-btn {
    width: 50px;
    height: 50px;
    border: 2px solid #333;
    background-color: white;
    border-radius: 50%;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .zoom-btn:hover {
    background-color: #f0f0f0;
    transform: scale(1.1);
  }

  .zoom-btn:active {
    transform: scale(0.95);
  }

  .zoom-level {
    display: flex;
    align-items: center;
    padding: 0 15px;
    background-color: white;
    border: 2px solid #333;
    border-radius: 25px;
    font-weight: bold;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  /* Panneau d'exercice */
  .exercise-panel {
    position: fixed;
    right: clamp(0.5cm, 2vw, 1cm);
    top: 50%;
    transform: translateY(-50%);
    width: clamp(220px, 25vw, 320px);
    max-width: calc(100vw - 12cm);
    z-index: 10;
    background-color: white;
    border: 3px solid #333;
    border-radius: 15px;
    padding: clamp(12px, 2vw, 20px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  @media (max-width: 1024px) {
    .exercise-panel {
      width: clamp(180px, 28vw, 240px);
      right: clamp(0.6cm, 2vw, 1cm);
    }
    .main-layout {
      padding-right: calc(10cm + 6vw); /* r√©serve plus large pour √©viter le chevauchement */
    }
  }

  @media (max-width: 768px) {
    .exercise-panel {
      position: static;
      width: 100%;
      max-width: calc(100vw - 1cm);
      padding: clamp(12px, 2vw, 15px);
      margin: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  }

  @media (max-width: 480px) {
    .exercise-panel {
      width: 100%;
      max-width: calc(100vw - 1cm);
      padding: 12px;
    }
  }

  .exercise-title {
    font-size: clamp(16px, 2vw, 20px);
    font-weight: bold;
    text-align: center;
    margin-bottom: clamp(10px, 1.5vw, 15px);
    color: #333;
    border-bottom: 2px solid #333;
    padding-bottom: clamp(8px, 1vw, 10px);
  }

  .question-number {
    font-size: clamp(14px, 1.5vw, 16px);
    font-weight: bold;
    margin-bottom: clamp(8px, 1vw, 10px);
    color: #666;
  }

  .instruction {
    font-size: clamp(12px, 1.3vw, 14px);
    margin-bottom: clamp(10px, 1.5vw, 15px);
    color: #444;
    line-height: 1.4;
  }

  .input-group {
    margin-bottom: 8px;
  }

  .input-group label {
    display: block;
    font-size: 13px;
    font-weight: bold;
    margin-bottom: 3px;
    color: #333;
  }

  .input-group input {
    width: 100%;
    padding: clamp(6px, 0.8vw, 8px);
    font-size: clamp(13px, 1.3vw, 15px);
    border: 2px solid #333;
    border-radius: 5px;
    box-sizing: border-box;
  }

  .exercise-btn {
    width: 100%;
    padding: clamp(8px, 1vw, 10px);
    font-size: clamp(13px, 1.4vw, 15px);
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: clamp(6px, 0.8vw, 8px);
  }

  .btn-verify {
    background-color: #4CAF50;
    color: white;
  }

  .btn-verify:hover {
    background-color: #45a049;
    transform: scale(1.02);
  }

  .btn-next {
    background-color: #2196F3;
    color: white;
    display: none;
  }

  .btn-next:hover {
    background-color: #0b7dda;
    transform: scale(1.02);
  }

  .btn-restart {
    background-color: #ff9800;
    color: white;
    display: none;
  }

  .btn-restart:hover {
    background-color: #e68900;
    transform: scale(1.02);
  }

  .btn-home {
    background-color: #607D8B;
    color: white;
    margin-top: 10px;
  }

  .btn-home:hover {
    background-color: #546E7A;
    transform: scale(1.02);
  }

  .feedback {
    padding: 8px;
    border-radius: 5px;
    margin-bottom: 8px;
    font-weight: bold;
    text-align: center;
    display: none;
    font-size: clamp(12px, 1.3vw, 14px);
  }

  .feedback.correct {
    background-color: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
  }

  .feedback.incorrect {
    background-color: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
  }

  .score-display {
    text-align: center;
    font-size: clamp(16px, 1.8vw, 18px);
    font-weight: bold;
    margin-top: clamp(8px, 1vw, 10px);
    padding: clamp(8px, 1vw, 10px);
    background-color: #f0f0f0;
    border-radius: 8px;
  }

  .final-score {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .final-score h2 {
    color: #333;
    margin-bottom: 15px;
  }

  .final-score .percentage {
    font-size: 36px;
    font-weight: bold;
    color: #4CAF50;
    margin: 15px 0;
  }

  /* Styles page d'accueil */
  .intro-page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--gris);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 16px;
    overflow-y: auto;
  }

  .intro-page.hidden {
    display: none;
  }

  .banner {
    background: var(--noir);
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    width: 100%;
    max-width: 820px;
    margin-bottom: 15px;
  }

  .page-title {
    color: var(--orange);
    text-align: center;
    margin: 8px 0;
    font-size: 2rem;
  }

  .subtitle {
    color: #555;
    text-align: center;
    margin-bottom: 18px;
    font-size: 1.2rem;
  }

  .intro-card {
    background: #fff;
    padding: 20px;
    margin: 10px auto;
    border-left: 8px solid var(--orange);
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    width: 100%;
    max-width: 820px;
    text-align: center;
  }

  .intro-card p {
    font-weight: 600;
  }

  .intro-btn {
    background: var(--orange);
    color: #fff;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    font-size: 1.05rem;
    cursor: pointer;
    margin: 10px;
    width: 200px;
    font-weight: bold;
  }

  .intro-btn:hover {
    background: #e65c00;
    transform: scale(1.05);
  }

  .intro-input {
    width: 90%;
    max-width: 420px;
    padding: 10px;
    font-size: 1.1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 10px;
  }

  .main-layout.hidden {
    display: none;
  }
</style>
</head>
<body>

<!-- Page d'introduction -->
<div class="intro-page" id="introPage">
  <div class="banner">üìö TOPOGRAPHIE - MODULE 3 üìö</div>
  <h1 class="page-title">CALCULER UNE DISTANCE</h1>
  <p class="subtitle" id="quizSubtitle"></p>

  <div id="intro">
    <div id="testTypeSelection" class="intro-card">
      <p style="font-weight:600; font-size:1.1rem;">S√©lectionnez le type de test</p>
      <div style="margin-top:20px;">
        <button id="exercice1Btn" class="intro-btn" style="background:#4CAF50;">üìò Exercice 1<br><span style="font-size:0.85rem;">(20 questions)</span></button>
        <button id="exercice2Btn" class="intro-btn" style="background:#2196F3;">üìó Exercice 2<br><span style="font-size:0.85rem;">(20 questions)</span></button>
        <button id="evaluationBtn" class="intro-btn" style="background:#ff6600;">üéØ √âvaluation<br><span style="font-size:0.85rem;">(10 questions)</span></button>
      </div>
    </div>
    
    <div id="nameSelection" class="intro-card" style="display:none;">
      <p id="welcomeTitle" style="font-weight:600; font-size:1.1rem;">Bienvenue</p>
      <p id="welcomeText">Merci d'indiquer votre nom avant de commencer :</p>
      <input id="candidateName" class="intro-input" type="text" placeholder="Nom de l'√©l√®ve">
      <div style="margin-top:12px;">
        <button id="startExerciseBtn" class="intro-btn" disabled>‚û°Ô∏è Commencer</button>
      </div>
    </div>
  </div>
</div>

<div class="main-layout" id="mainLayout">
<div class="container">
  <div class="mires-viewport" id="miresViewport" role="slider" aria-label="R√®gle de mesure verticale" aria-valuemin="0" aria-valuemax="4000" aria-valuenow="0" tabindex="0">
    <div class="mires-wrapper" id="miresWrapper">
      <!-- mire39 (39) -->
<div class="mire" id="mire39">
  <div class="trait-noir"></div>
</div>

<!-- mire38 (38) -->
<div class="mire" id="mire38">
  <div class="trait-noir"></div>
</div>

<!-- mire37 (37) -->
<div class="mire" id="mire37">
  <div class="trait-noir"></div>
</div>

<!-- mire36 (36) -->
<div class="mire" id="mire36">
  <div class="trait-noir"></div>
</div>

<!-- mire35 (35) -->
<div class="mire" id="mire35">
  <div class="trait-noir"></div>
</div>

<!-- mire34 (34) -->
<div class="mire" id="mire34">
  <div class="trait-noir"></div>
</div>

<!-- mire33 (33) -->
<div class="mire" id="mire33">
  <div class="trait-noir"></div>
</div>

<!-- mire32 (32) -->
<div class="mire" id="mire32">
  <div class="trait-noir"></div>
</div>

<!-- mire31 (31) -->
<div class="mire" id="mire31">
  <div class="trait-noir"></div>
</div>

<!-- mire30 (30) -->
<div class="mire" id="mire30">
  <div class="trait-noir"></div>
</div>

<!-- mire29 (29) -->
<div class="mire" id="mire29">
  <div class="trait-noir"></div>
</div>

<!-- mire28 (28) -->
<div class="mire" id="mire28">
  <div class="trait-noir"></div>
</div>

<!-- mire27 (27) -->
<div class="mire" id="mire27">
  <div class="trait-noir"></div>
</div>

<!-- mire26 (26) -->
<div class="mire" id="mire26">
  <div class="trait-noir"></div>
</div>

<!-- mire25 (25) -->
<div class="mire" id="mire25">
  <div class="trait-noir"></div>
</div>

<!-- mire24 (24) -->
<div class="mire" id="mire24">
  <div class="trait-noir"></div>
</div>

<!-- mire23 (23) -->
<div class="mire" id="mire23">
  <div class="trait-noir"></div>
</div>

<!-- mire22 (22) -->
<div class="mire" id="mire22">
  <div class="trait-noir"></div>
</div>

<!-- mire21 (21) -->
<div class="mire" id="mire21">
  <div class="trait-noir"></div>
</div>

<!-- mire20 (20) -->
<div class="mire" id="mire20">
  <div class="trait-noir"></div>
</div>

<!-- mire19 (19) -->
<div class="mire" id="mire19">
  <div class="trait-noir"></div>
</div>

<!-- mire18 (18) -->
<div class="mire" id="mire18">
  <div class="trait-noir"></div>
</div>

<!-- mire17 (17) -->
<div class="mire" id="mire17">
  <div class="trait-noir"></div>
</div>

<!-- mire16 (16) -->
<div class="mire" id="mire16">
  <div class="trait-noir"></div>
</div>

<!-- mire15 (15) -->
<div class="mire" id="mire15">
  <div class="trait-noir"></div>
</div>

<!-- mire14 (14) -->
<div class="mire" id="mire14">
  <div class="trait-noir"></div>
</div>

<!-- mire13 (13) -->
<div class="mire" id="mire13">
  <div class="trait-noir"></div>
</div>

<!-- mire12 (12) -->
<div class="mire" id="mire12">
  <div class="trait-noir"></div>
</div>

<!-- mire11 (11) -->
<div class="mire" id="mire11">
  <div class="trait-noir"></div>
</div>

<!-- mire10 (10) -->
<div class="mire" id="mire10">
  <div class="trait-noir"></div>
</div>

<!-- mire9 (9) -->
<div class="mire" id="mire9">
  <div class="trait-noir"></div>
</div>

<!-- mire8 (8) -->
<div class="mire" id="mire8">
  <div class="trait-noir"></div>
</div>

<!-- mire7 (7) -->
<div class="mire" id="mire7">
  <div class="trait-noir"></div>
</div>

<!-- mire6 (6) -->
<div class="mire" id="mire6">
  <div class="trait-noir"></div>
</div>

<!-- mire5 (5) -->
<div class="mire" id="mire5">
  <div class="trait-noir"></div>
</div>

<!-- mire4 (4) -->
<div class="mire" id="mire4">
  <div class="trait-noir"></div>
</div>

<!-- mire3 (3) -->
<div class="mire" id="mire3">
  <div class="trait-noir"></div>
</div>

<!-- mire2 (2) -->
<div class="mire" id="mire2">
  <div class="trait-noir"></div>
</div>

<!-- mire1 (1) -->
<div class="mire" id="mire1">
  <div class="trait-noir"></div>
</div>

<!-- mire0 (0) -->
<div class="mire" id="mire0">
  <div class="trait-noir"></div>
</div>
    </div>
  </div>
  <div class="reticule">
  <svg width="12cm" height="12cm" viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title desc">
    <title id="title">R√©ticule de vis√©e</title>
    <desc id="desc">Deux segments perpendiculaires de 8 cm se coupant en leur milieu avec cercle de 8 cm de diam√®tre</desc>

    <!-- centre -->
    <circle cx="600" cy="600" r="6" fill="#333" />

    <!-- segments : longueur 8 cm -> 800 unit√©s (√©chelle 100 unit√©s = 1 cm) -->
    <!-- segment horizontal -->
    <line x1="200" y1="600" x2="1000" y2="600" stroke="#000" stroke-width="8" stroke-linecap="round" />
    <!-- segment vertical -->
    <line x1="600" y1="200" x2="600" y2="1000" stroke="#000" stroke-width="8" stroke-linecap="round" />

    <!-- petit segment horizontal √† 3 cm au-dessus de l'intersection (5 cm de long) -->
    <line x1="375" y1="350" x2="825" y2="350" stroke="#000" stroke-width="6" stroke-linecap="round" />

    <!-- segment sym√©trique sous l'intersection -->
    <line x1="375" y1="850" x2="825" y2="850" stroke="#000" stroke-width="6" stroke-linecap="round" />

    <!-- cercle de diam√®tre 8 cm -> rayon 4 cm -> 400 unit√©s -->
    <circle cx="600" cy="600" r="400" fill="none" stroke="#000" stroke-width="6" />
  </svg>
</div>

</div>

<!-- Panneau d'exercice -->
<div class="exercise-panel" id="exercisePanel">
  <div class="exercise-title">Exercice de Lecture</div>
  
  <div id="exerciseContent">
    <div class="question-number" id="questionNumber">Question 1/20</div>
    <div class="instruction" id="instructionText">Lisez la valeur affich√©e sur la mire et saisissez-la ci-dessous :</div>
    
    <!-- Champ unique pour exercices 1 et 2 -->
    <div class="input-group" id="singleInputGroup">
      <label for="userAnswer">Votre r√©ponse (en mm) :</label>
      <input type="number" id="userAnswer" placeholder="Ex: 1234">
    </div>
    
    <!-- 3 champs pour l'√©valuation -->
    <div id="tripleInputGroup" style="display:none;">
      <div class="input-group">
        <label for="userAnswerTop">Fil stadim√©trique haut (en mm) :</label>
        <input type="number" id="userAnswerTop" placeholder="Ex: 1234">
      </div>
      <div class="input-group">
        <label for="userAnswerCenter">Fil niveleur - milieu (en mm) :</label>
        <input type="number" id="userAnswerCenter" placeholder="Ex: 1234">
      </div>
      <div class="input-group">
        <label for="userAnswerBottom">Fil stadim√©trique bas (en mm) :</label>
        <input type="number" id="userAnswerBottom" placeholder="Ex: 1234">
      </div>
      <div class="input-group" id="verificationInputGroup" style="display:none;">
        <label for="userAnswerVerification">Distance (en m) :</label>
        <input type="number" id="userAnswerVerification" step="0.1" inputmode="decimal" placeholder="Ex: 14.8">
      </div>
    </div>
    
    <div class="feedback" id="feedback"></div>
    
    <button class="exercise-btn btn-verify" id="btnVerify">V√©rifier</button>
    <button class="exercise-btn btn-next" id="btnNext">Question suivante</button>
    
    <div class="score-display" id="scoreDisplay">Score: 0/0</div>
  </div>
  
  <div class="final-score" id="finalScore">
    <h2>Exercice termin√© !</h2>
    <div class="percentage" id="finalPercentage">0%</div>
    <div id="finalMessage"></div>
    <button class="exercise-btn btn-restart" id="btnRestart">üîÑ Nouvelle √©valuation</button>
  </div>
  
  <button class="exercise-btn btn-home" id="btnHome">üè† Retour √† l'accueil</button>
</div>

</div>

<div class="reading-values" id="readingValues">
  <div class="reading-item"><span class="reading-label">Fil stadim√©trique haut</span><span class="reading-mm" id="readingTop">0 mm</span></div>
  <div class="reading-item"><span class="reading-label">Fil niveleur (milieu)</span><span class="reading-mm" id="readingCenter">0 mm</span></div>
  <div class="reading-item"><span class="reading-label">Fil stadim√©trique bas</span><span class="reading-mm" id="readingBottom">0 mm</span></div>
  </div>

<div class="zoom-controls">
  <button class="zoom-btn" id="zoomOut" title="Zoom arri√®re" aria-label="R√©duire le zoom">‚àí</button>
  <div class="zoom-level" id="zoomLevel">100%</div>
  <button class="zoom-btn" id="zoomIn" title="Zoom avant" aria-label="Augmenter le zoom">+</button>
</div>

<script>
// ===== SYST√àME D'AUTHENTIFICATION ET PAGE D'ACCUEIL =====
const AUTHORIZED_CANDIDATES = {
  "Professeur": ["MARINO","CHARDON","CHIOTTI","MATHIEU","MAUSSION"],
  "1 cetpc": ["FONELLERAS","BONTEMPS","BRIATORE","BUCCIO","DIONISI","ERETEO","GARNERO","GRISONI","GUENEAU","HADANGUE","LACROIX","LEJEUNE","MAAZAOUI","MARTINEAU","MONELLO","PI-BUTHION","QUILICO","REMY","SANTIAGO","SCIARAFFA","THEVENET","TRUFFE","VILLEROY"],
  "2 cetpc": ["ALBERT","AUDISIO","BABA","BERTOLOTTO","BOUCHEE","BOUFFART","BOURGUIGNON","BOUSQUET","CAPPADORO","COLPAERT","CULMINE","DOYEN","GAALOUL","GEORGE","GUEURUNURIAN","MONTEIRO","PAGE","PALAGONIA","PELLET","PONZO","PRUVOST","RICHARD","TETI"]
};

let candidateName = "";
let testType = "Exercice 1";
let currentExerciseType = "exercice 1"; // exercice 1 ou exercice 2

// Gestion de la page d'introduction
function showIntroPage() {
  document.getElementById('introPage').classList.remove('hidden');
  document.getElementById('mainLayout').classList.add('hidden');
  document.getElementById('testTypeSelection').style.display = 'block';
  document.getElementById('nameSelection').style.display = 'none';
  document.getElementById('candidateName').value = '';
  document.getElementById('startExerciseBtn').disabled = true;
  // R√©initialiser √† exercice 1 par d√©faut
  currentExerciseType = 'exercice 1';
}

function selectTestType(type) {
  testType = type;
  document.getElementById('testTypeSelection').style.display = 'none';
  document.getElementById('nameSelection').style.display = 'block';
  document.getElementById('candidateName').focus();
}

function startExercise() {
  candidateName = document.getElementById('candidateName').value.trim().toUpperCase();
  
  if (!candidateName) return;
  
  // V√©rification de l'autorisation
  const isAuthorized = Object.values(AUTHORIZED_CANDIDATES).some(group => 
    group.includes(candidateName)
  );
  
  if (!isAuthorized) {
    alert("‚ùå Acc√®s refus√©. Votre nom n'est pas autoris√© pour faire ce test.");
    document.getElementById('candidateName').value = '';
    document.getElementById('startExerciseBtn').disabled = true;
    return;
  }
  
  // V√©rifier si c'est l'√©valuation et si le candidat l'a d√©j√† faite
  if (currentExerciseType === '√©valuation') {
    // Appeler Google Sheets pour v√©rifier
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyujQdTB7YO_lEdMmhkfsivNgq-2ktSX3Jtf65zbBPKyiM5x1SaGoDqUgaenNjrY0djzQ/exec';
    
    fetch(`${GOOGLE_SCRIPT_URL}?action=checkEvaluation&nom=${encodeURIComponent(candidateName)}`)
      .then(res => res.json())
      .then(data => {
        if (data.hasCompleted) {
          alert('‚ö†Ô∏è Vous avez d√©j√† effectu√© l\'√©valuation. Vous ne pouvez la passer qu\'une seule fois.');
          document.getElementById('candidateName').value = '';
          document.getElementById('startExerciseBtn').disabled = true;
        } else {
          // Candidat non trouv√©, peut d√©marrer
          launchExercise();
        }
      })
      .catch(err => {
        console.error('Erreur lors de la v√©rification:', err);
        alert('‚ö†Ô∏è Erreur de connexion. Veuillez r√©essayer.');
      });
  } else {
    // Pour exercice 1 et 2, d√©marrer directement
    launchExercise();
  }
}

function launchExercise() {
  // Masquer l'intro et afficher l'exercice
  document.getElementById('introPage').classList.add('hidden');
  document.getElementById('mainLayout').classList.remove('hidden');
  
  console.log('Exercice s√©lectionn√©:', currentExerciseType);
  
  // Attendre que le layout soit rendu avant d'initialiser l'exercice
  setTimeout(() => {
    cachedPxPerMM = null; // Forcer le recalcul des dimensions
    updateRightDigitOffsetPx();
    console.log('Initialisation de:', currentExerciseType);
    initExercise();
  }, 100);
}

// √âv√©nements de la page d'introduction
document.addEventListener('DOMContentLoaded', () => {
  showIntroPage();
  
  document.getElementById('exercice1Btn').addEventListener('click', () => {
    console.log('Clic sur Exercice 1');
    selectTestType('Exercice 1');
    currentExerciseType = 'exercice 1';
    console.log('currentExerciseType d√©fini √†:', currentExerciseType);
  });
  
  document.getElementById('exercice2Btn').addEventListener('click', () => {
    console.log('Clic sur Exercice 2');
    selectTestType('Exercice 2');
    currentExerciseType = 'exercice 2';
    console.log('currentExerciseType d√©fini √†:', currentExerciseType);
  });
  
  document.getElementById('evaluationBtn').addEventListener('click', () => {
    console.log('Clic sur √âvaluation');
    selectTestType('√âvaluation');
    currentExerciseType = '√©valuation';
    console.log('currentExerciseType d√©fini √†:', currentExerciseType);
  });
  
  document.getElementById('candidateName').addEventListener('input', () => {
    const name = document.getElementById('candidateName').value.trim();
    document.getElementById('startExerciseBtn').disabled = name.length < 2;
  });
  
  document.getElementById('startExerciseBtn').addEventListener('click', startExercise);
  
  // Permettre de valider avec Entr√©e
  document.getElementById('candidateName').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !document.getElementById('startExerciseBtn').disabled) {
      startExercise();
    }
  });
});

// ===== CODE ORIGINAL DE L'EXERCICE =====
  // Couleurs des mires
  const mire1Colors = [
    ['white','white','white','white'],
    ['white','white','red','white'],
    ['white','white','white','white'],
    ['white','white','red','white'],
    ['white','white','white','white'],
    ['white','white','red','red'],
    ['white','white','white','red'],
    ['white','white','red','red'],
    ['white','white','white','red'],
    ['white','white','red','red']
  ];

  const mire2Colors = [
    ['white','white','white','white'],
    ['white','red','white','white'],
    ['white','white','white','white'],
    ['white','red','white','white'],
    ['white','white','white','white'],
    ['red','red','white','white'],
    ['red','white','white','white'],
    ['red','red','white','white'],
    ['red','white','white','white'],
    ['red','red','white','white']
  ];

  const mire1BlackColors = [
    ['white','white','white','white'],
    ['white','white','black','white'],
    ['white','white','white','white'],
    ['white','white','black','white'],
    ['white','white','white','white'],
    ['white','white','black','black'],
    ['white','white','white','black'],
    ['white','white','black','black'],
    ['white','white','white','black'],
    ['white','white','black','black']
  ];

  const mire2BlackColors = [
    ['white','white','white','white'],
    ['white','black','white','white'],
    ['white','white','white','white'],
    ['white','black','white','white'],
    ['white','white','white','white'],
    ['black','black','white','white'],
    ['black','white','white','white'],
    ['black','black','white','white'],
    ['black','white','white','white'],
    ['black','black','white','white']
  ];

  function generateMire(mireId, colors) {
    const mire = document.getElementById(mireId);
    colors.forEach((line, index) => {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'line-container';
      if (index === 0) {
        lineDiv.classList.add('first-line');
      }
      line.forEach(color => {
        const square = document.createElement('div');
        square.className = `square ${color}`;
        lineDiv.appendChild(square);
      });
      mire.appendChild(lineDiv);
    });
  }

  // G√©n√©rer les mires avec une boucle optimis√©e
  for (let i = 0; i <= 39; i++) {
    let colors;
    // Mires 0-9 et 20-29 : noir/blanc
    // Mires 10-19 et 30-39 : rouge/blanc
    if ((i >= 0 && i <= 9) || (i >= 20 && i <= 29)) {
      colors = (i % 2 === 0) ? mire1BlackColors : mire2BlackColors;
    } else {
      colors = (i % 2 === 0) ? mire1Colors : mire2Colors;
    }
    generateMire(`mire${i}`, colors);
    const mireEl = document.getElementById(`mire${i}`);
    const isRedGroup = (i >= 10 && i <= 19) || (i >= 30 && i <= 39);
    if (isRedGroup && mireEl) {
      mireEl.classList.add('red-group');
    }
  }

  // Positions personnalis√©es des chiffres pour chaque mire
  const chiffresPositions = {
    mire0: { left: '0%', bottom: '0cm', value: '00' },
    mire1: { left: '50%', bottom: '-1mm', value: '01' },
    mire2: { left: '0%', bottom: '-1mm', value: '02' },
    mire3: { left: '50%', bottom: '-1mm', value: '03' },
    mire4: { left: '0%', bottom: '-1mm', value: '04' },
    mire5: { left: '50%', bottom: '-1mm', value: '05' },
    mire6: { left: '0%', bottom: '-1mm', value: '06' },
    mire7: { left: '50%', bottom: '-1mm', value: '07' },
    mire8: { left: '0%', bottom: '-1mm', value: '08' },
    mire9: { left: '50%', bottom: '-1mm', value: '09' },
    mire10: { left: '0%', bottom: '-1mm', value: '10' },
    mire11: { left: '50%', bottom: '-1mm', value: '11' },
    mire12: { left: '0%', bottom: '-1mm', value: '12' },
    mire13: { left: '50%', bottom: '-1mm', value: '13' },
    mire14: { left: '0%', bottom: '-1mm', value: '14' },
    mire15: { left: '50%', bottom: '-1mm', value: '15' },
    mire16: { left: '0%', bottom: '-1mm', value: '16' },
    mire17: { left: '50%', bottom: '-1mm', value: '17' },
    mire18: { left: '0%', bottom: '-1mm', value: '18' },
    mire19: { left: '50%', bottom: '-1mm', value: '19' },
    mire20: { left: '0%', bottom: '-1mm', value: '20' },
    mire21: { left: '50%', bottom: '-1mm', value: '21' },
    mire22: { left: '0%', bottom: '-1mm', value: '22' },
    mire23: { left: '50%', bottom: '-1mm', value: '23' },
    mire24: { left: '0%', bottom: '-1mm', value: '24' },
    mire25: { left: '50%', bottom: '-1mm', value: '25' },
    mire26: { left: '0%', bottom: '-1mm', value: '26' },
    mire27: { left: '50%', bottom: '-1mm', value: '27' },
    mire28: { left: '0%', bottom: '-1mm', value: '28' },
    mire29: { left: '50%', bottom: '-1mm', value: '29' },
    mire30: { left: '0%', bottom: '-1mm', value: '30' },
    mire31: { left: '50%', bottom: '-1mm', value: '31' },
    mire32: { left: '0%', bottom: '-1mm', value: '32' },
    mire33: { left: '50%', bottom: '-1mm', value: '33' },
    mire34: { left: '0%', bottom: '-1mm', value: '34' },
    mire35: { left: '50%', bottom: '-1mm', value: '35' },
    mire36: { left: '0%', bottom: '-1mm', value: '36' },
    mire37: { left: '50%', bottom: '-1mm', value: '37' },
    mire38: { left: '0%', bottom: '-1mm', value: '38' },
    mire39: { left: '50%', bottom: '-1mm', value: '39' }
  };

  function addChiffre(mireId, position) {
    const mire = document.getElementById(mireId);
    const chiffre = document.createElement('div');
    chiffre.className = 'chiffre';
    const mireNum = parseInt(mireId.replace('mire', ''));
    const groupNum = Math.floor(mireNum / 10);
    const isRedGroup = groupNum % 2 === 1;
    if (isRedGroup) {
      chiffre.classList.add('red');
    }
    const isRightColumn = position.left === '50%';
    chiffre.style.left = isRightColumn ? 'calc(50% + var(--right-digit-offset-px))' : position.left;
    chiffre.style.bottom = position.bottom;
    chiffre.textContent = position.value;
    mire.appendChild(chiffre);
  }

  // Ajouter les chiffres avec une boucle
  for (let i = 0; i <= 39; i++) {
    addChiffre(`mire${i}`, chiffresPositions[`mire${i}`]);
  }

  // Syst√®me de lecture avec graduation invisible
  const miresWrapper = document.getElementById('miresWrapper');
  const miresViewport = document.getElementById('miresViewport');
  const readingTop = document.getElementById('readingTop');
  const readingCenter = document.getElementById('readingCenter');
  const readingBottom = document.getElementById('readingBottom');
  const reticule = document.querySelector('.reticule');

  // Exercice
  const instructionText = document.getElementById('instructionText');

  let isDragging = false;
  let dragStart = 0;
  let wrapperStartPos = 0;

  // Constantes de conversion
  const MM_PER_CM = 10;
  const MIRE_HEIGHT_CM = 10;
  const MIRE_HEIGHT_MM = 100;
  const GRADUATION_MM = 1;
  const GRADUATION_CM = GRADUATION_MM / MM_PER_CM;
  const TOTAL_MIRES = 40;
  const TOTAL_MM = 4000;

  // Cache pour optimiser les performances
  let cachedPxPerMM = null;
  let zoomLevel = 1.0; // Niveau de zoom initial (100%)
  const MIN_ZOOM = 0.5; // 50%
  const MAX_ZOOM = 3.0; // 300%
  const ZOOM_STEP = 0.25; // Incr√©ment de 25%

  function pxPerMM() {
    if (cachedPxPerMM !== null) return cachedPxPerMM;
    const testMire = document.getElementById('mire0');
    if (!testMire) return 3.78;
    const rect = testMire.getBoundingClientRect();
    const height = rect.height;
    cachedPxPerMM = height / MIRE_HEIGHT_MM;
    return cachedPxPerMM;
  }

  // Offset en pixels pour les chiffres √† droite (distance exprim√©e en mm)
  const RIGHT_OFFSET_MM = 1.5; // 1,5 mm de marge √† droite

  function updateRightDigitOffsetPx() {
    const px = Math.max(2, Math.round(pxPerMM() * RIGHT_OFFSET_MM));
    document.documentElement.style.setProperty('--right-digit-offset-px', px + 'px');
  }

  // Recalculer le cache lors du redimensionnement
  window.addEventListener('resize', () => {
    cachedPxPerMM = null;
    updateRightDigitOffsetPx();
    updateReadingValue();
  });

  function getReadingValues() {
    const ppm = pxPerMM();
    const wrapperTop = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    const viewportHeight = miresViewport.clientHeight;
    const totalHeight = miresWrapper.scrollHeight;

    const rRect = reticule.getBoundingClientRect();
    const offsetTopPx = (350 - 600) / 1200 * rRect.height;   // n√©gatif
    const offsetCenterPx = 0;
    const offsetBottomPx = (850 - 600) / 1200 * rRect.height; // positif

    function computeMM(offsetPx) {
      const readingPosPixels = (viewportHeight / 2 + offsetPx) - wrapperTop;
      const mm = (totalHeight - readingPosPixels) / ppm;
      return Math.max(0, Math.min(TOTAL_MM, mm));
    }

    return {
      top: computeMM(offsetTopPx),
      center: computeMM(offsetCenterPx),
      bottom: computeMM(offsetBottomPx)
    };
  }

  function updateReadingValue() {
    const values = getReadingValues();
    readingTop.textContent = Math.round(values.top) + ' mm';
    readingCenter.textContent = Math.round(values.center) + ' mm';
    readingBottom.textContent = Math.round(values.bottom) + ' mm';
    miresViewport.setAttribute('aria-valuenow', Math.round(values.center));
  }

  function getTotalHeight() {
    return miresWrapper.scrollHeight;
  }

  function snapToGraduation(pos) {
    const pixelsPerMM = pxPerMM();
    const snapSizePixels = GRADUATION_MM * pixelsPerMM;
    return Math.round(pos / snapSizePixels) * snapSizePixels;
  }

  // DRAG & DROP D√âSACTIV√â - La mire ne peut pas √™tre d√©plac√©e par l'utilisateur
  // miresWrapper.addEventListener('mousedown', ...) supprim√©
  // document.addEventListener('mousemove', ...) supprim√©
  // document.addEventListener('mouseup', ...) supprim√©

// ----------------------------------------
// üéØ Scrolling par molette D√âSACTIV√â
// ----------------------------------------
// La molette ne peut pas d√©placer la mire pour l'exercice


// ----------------------------------------
// üéØ GESTION DU TOUCH D√âSACTIV√âE
// ----------------------------------------
// Les gestes tactiles ne peuvent pas d√©placer la mire
// let touchStartY = 0;
// miresViewport.addEventListener('touchstart', ...) supprim√©
// miresViewport.addEventListener('touchmove', ...) supprim√©
// miresViewport.addEventListener('touchend', ...) supprim√©

// ----------------------------------------
// üéØ NAVIGATION CLAVIER D√âSACTIV√âE
// ----------------------------------------
// Les touches fl√®ches ne peuvent pas d√©placer la mire
// miresViewport.addEventListener('keydown', ...) supprim√©

// ----------------------------------------
// üîç CONTR√îLES DE ZOOM
// ----------------------------------------
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const zoomLevelDisplay = document.getElementById('zoomLevel');

function applyZoom() {
  document.documentElement.style.setProperty('--zoom-level', zoomLevel);
  zoomLevelDisplay.textContent = Math.round(zoomLevel * 100) + '%';
  cachedPxPerMM = null; // Invalider le cache
  
  // Attendre que le DOM soit mis √† jour
  setTimeout(() => {
    updateRightDigitOffsetPx();
    updateReadingValue();
  }, 50);
}

zoomInBtn.addEventListener('click', () => {
  if (zoomLevel < MAX_ZOOM) {
    zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
    applyZoom();
  }
});

zoomOutBtn.addEventListener('click', () => {
  if (zoomLevel > MIN_ZOOM) {
    zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
    applyZoom();
  }
});

// Zoom avec Ctrl + molette (bonus)
if (!('ontouchstart' in window)) {
  document.addEventListener('wheel', (e) => {
    if (e.ctrlKey) {
      e.preventDefault();
      if (e.deltaY < 0 && zoomLevel < MAX_ZOOM) {
        zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
        applyZoom();
      } else if (e.deltaY > 0 && zoomLevel > MIN_ZOOM) {
        zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
        applyZoom();
      }
    }
  }, { passive: false });
}


  // Position initiale (mire0 au milieu du viewport pour lire 0 mm)
  window.onload = () => {
  updateRightDigitOffsetPx();
  const viewportHeight = miresViewport.clientHeight;
  const totalHeight = getTotalHeight();
  const initialTop = (viewportHeight / 2) - totalHeight;
  miresWrapper.style.top = initialTop + 'px';
  updateReadingValue();
  // Activer le focus pour permettre la navigation au clavier d√®s l'ouverture
  miresViewport.focus();
  
  // L'exercice ne sera initialis√© que lors du clic sur "Commencer"
};

// ----------------------------------------
// üéì SYST√àME D'EXERCICE
// ----------------------------------------
let currentQuestion = 0;
let score = 0;
let questions = [];
const TOTAL_QUESTIONS = 20;
const TOLERANCE_MM = 3;

const READING_TYPES = ['top', 'center', 'bottom'];
const READING_LABELS = {
  top: 'Lecture fil stadim√©trique haut',
  center: 'Lecture fil niveleur (milieu)',
  bottom: 'Lecture fil stadim√©trique bas'
};

// G√©n√©rer les positions al√©atoires dans toute la plage (0-4000 mm)
function generateQuestions() {
  console.log('generateQuestions() appel√©e - currentExerciseType:', currentExerciseType);
  questions = [];
  const usedValues = new Set();

  // Nombre de questions selon le type d'exercice
  const numQuestions = currentExerciseType === '√©valuation' ? 10 : 20;

  // R√©partition demand√©e
  let readingPlan;
  if (currentExerciseType === '√©valuation') {
    // √âvaluation : 3 haut, 4 milieu, 3 bas (total = 10)
    readingPlan = [
      ...Array(3).fill('top'),
      ...Array(4).fill('center'),
      ...Array(3).fill('bottom')
    ];
  } else {
    // Exercices 1 et 2 : 6 haut, 8 milieu, 6 bas (total = 20)
    readingPlan = [
      ...Array(6).fill('top'),
      ...Array(8).fill('center'),
      ...Array(6).fill('bottom')
    ];
  }

  // Shuffle du plan (Fisher‚ÄìYates)
  for (let i = readingPlan.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [readingPlan[i], readingPlan[j]] = [readingPlan[j], readingPlan[i]];
  }

  // D√©finir les niveaux de zoom selon le type d'exercice
  let zoomPlan = [];
  if (currentExerciseType === '√©valuation') {
    // √âvaluation : r√©partition avec zoom variable sur 10 questions
    zoomPlan = [
      ...Array(1).fill(0.5),   // 1 question √† 50%
      ...Array(2).fill(0.75),  // 2 questions √† 75%
      ...Array(2).fill(1.0),   // 2 questions √† 100%
      ...Array(1).fill(1.25),  // 1 question √† 125%
      ...Array(2).fill(1.5),   // 2 questions √† 150%
      ...Array(1).fill(1.75),  // 1 question √† 175%
      ...Array(1).fill(2.0)    // 1 question √† 200%
    ];
    // M√©langer l'ordre des zooms
    for (let i = zoomPlan.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [zoomPlan[i], zoomPlan[j]] = [zoomPlan[j], zoomPlan[i]];
    }
  } else if (currentExerciseType === 'exercice 2') {
    // Exercice 2 : r√©partition avec zoom variable sur 20 questions
    zoomPlan = [
      ...Array(2).fill(0.5),   // 2 questions √† 50%
      ...Array(3).fill(0.75),  // 3 questions √† 75%
      ...Array(3).fill(1.0),   // 3 questions √† 100%
      ...Array(3).fill(1.25),  // 3 questions √† 125%
      ...Array(3).fill(1.5),   // 3 questions √† 150%
      ...Array(3).fill(1.75),  // 3 questions √† 175%
      ...Array(3).fill(2.0)    // 3 questions √† 200%
    ];
    // M√©langer l'ordre des zooms
    for (let i = zoomPlan.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [zoomPlan[i], zoomPlan[j]] = [zoomPlan[j], zoomPlan[i]];
    }
  } else {
    // Exercice 1 : toutes les questions √† 100%
    zoomPlan = Array(20).fill(1.0);
  }

  readingPlan.forEach((readingType, index) => {
    let value;
    do {
      value = Math.floor(Math.random() * 3900) + 50; // 50..3949
    } while (usedValues.has(value));

    usedValues.add(value);
    questions.push({
      targetValue: value,
      readingType,
      zoomLevel: zoomPlan[index],
      answered: false,
      correct: null,
      userAnswer: null
    });
  });
}

// Positionner la mire √† une valeur sp√©cifique
function setMirePosition(targetMM) {
  const pixelsPerMM = pxPerMM();
  const viewportHeight = miresViewport.clientHeight;
  const totalHeight = getTotalHeight();
  
  // Calculer la position du wrapper pour afficher targetMM au r√©ticule
  const readingPosPixels = totalHeight - (targetMM * pixelsPerMM);
  const newTop = (viewportHeight / 2) - readingPosPixels;
  
  miresWrapper.style.top = newTop + 'px';
  updateReadingValue();
}

// Obtenir la valeur actuelle affich√©e
function getCurrentMireValue() {
  const text = readingValue.textContent;
  return parseInt(text.replace(' mm', ''));
}

// Initialiser l'exercice
function initExercise() {
  generateQuestions();
  currentQuestion = 0;
  score = 0;
  
  // R√©initialiser l'affichage du panneau
  document.getElementById('exerciseContent').style.display = 'block';
  document.getElementById('finalScore').style.display = 'none';
  document.getElementById('feedback').style.display = 'none';
  document.getElementById('userAnswer').value = '';
  
  showQuestion();
}

// Afficher une question
function showQuestion() {
  if (currentQuestion >= TOTAL_QUESTIONS) {
    showFinalScore();
    return;
  }
  
  const question = questions[currentQuestion];
  
  // Appliquer le niveau de zoom de la question
  zoomLevel = question.zoomLevel;
  applyZoom();
  
  // Attendre que le zoom soit appliqu√© avant de positionner la mire
  setTimeout(() => {
    // Positionner la mire
    setMirePosition(question.targetValue);
  }, 100);
  
  // Afficher les bons champs de saisie selon le type d'exercice
  // Tous les exercices utilisent maintenant les 4 champs
  document.getElementById('singleInputGroup').style.display = 'none';
  document.getElementById('tripleInputGroup').style.display = 'block';
  document.getElementById('verificationInputGroup').style.display = 'block';
  document.getElementById('userAnswerTop').value = '';
  document.getElementById('userAnswerCenter').value = '';
  document.getElementById('userAnswerBottom').value = '';
  document.getElementById('userAnswerVerification').value = '';
  document.getElementById('userAnswerTop').disabled = false;
  document.getElementById('userAnswerCenter').disabled = false;
  document.getElementById('userAnswerBottom').disabled = false;
  document.getElementById('userAnswerVerification').disabled = false;
  instructionText.textContent = 'Lisez les 3 fils (haut, milieu, bas) et calculez la distance (en m) :';
  
  // Mise √† jour de l'interface
  const zoomInfo = (currentExerciseType === 'exercice 2' || currentExerciseType === '√©valuation') ? ` - Zoom: ${Math.round(question.zoomLevel * 100)}%` : '';
  document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}/${TOTAL_QUESTIONS}${zoomInfo}`;
  document.getElementById('feedback').style.display = 'none';
  document.getElementById('btnVerify').style.display = 'block';
  document.getElementById('btnNext').style.display = 'none';
  
  // Tous les exercices utilisent maintenant les 4 champs
  document.getElementById('userAnswerTop').focus();
  
  updateScoreDisplay();
}

// V√©rifier la r√©ponse
function verifyAnswer() {
  const question = questions[currentQuestion];
  const readings = getReadingValues();
  
  let isCorrect = false;
  let userAnswer = null;
  let expected = null;
  let difference = 0;
  
  // Fonction pour v√©rifier si un nombre se termine par 0, 2, 5 ou 7
  function isValidReading(value) {
    const lastDigit = value % 10;
    return lastDigit === 0 || lastDigit === 2 || lastDigit === 5 || lastDigit === 7;
  }
  
  // Tous les exercices : v√©rifier les 3 lectures + distance
  const userInputTop = document.getElementById('userAnswerTop').value;
  const userInputCenter = document.getElementById('userAnswerCenter').value;
  const userInputBottom = document.getElementById('userAnswerBottom').value;
  const userInputDistanceRaw = document.getElementById('userAnswerVerification').value;
  
  const _distanceParsed = parseFloat(String(userInputDistanceRaw).replace(',', '.'));
  if (userInputTop === '' || userInputCenter === '' || userInputBottom === '' || userInputDistanceRaw === '' ||
      isNaN(userInputTop) || isNaN(userInputCenter) || isNaN(userInputBottom) || isNaN(_distanceParsed)) {
    alert('Veuillez saisir les 4 valeurs num√©riques.');
    return;
  }
  
  const userAnswerTop = parseInt(userInputTop);
  const userAnswerCenter = parseInt(userInputCenter);
  const userAnswerBottom = parseInt(userInputBottom);
  const userAnswerDistance = _distanceParsed;
  
  // V√©rifier que toutes les lectures se terminent par 0, 2, 5 ou 7
  if (!isValidReading(userAnswerTop) || !isValidReading(userAnswerCenter) || 
      !isValidReading(userAnswerBottom)) {
    alert('‚ùå Les lectures (H/M/B) doivent se terminer par 0, 2, 5 ou 7 (graduations de la mire).');
    return;
  }
  
  // Arrondir les lectures attendues pour la comparaison (graduations de la mire)
  const expectedTop = Math.round(readings.top);
  const expectedCenter = Math.round(readings.center);
  const expectedBottom = Math.round(readings.bottom);
  
  // Calculer la distance avec les valeurs arrondies
  const expectedDistance = Math.round(((expectedTop - expectedBottom) / 10) * 10) / 10;
  
  const diffTop = Math.abs(userAnswerTop - expectedTop);
  const diffCenter = Math.abs(userAnswerCenter - expectedCenter);
  const diffBottom = Math.abs(userAnswerBottom - expectedBottom);
  const diffDistance = Math.abs(userAnswerDistance - expectedDistance);
  
  // Les 4 lectures doivent √™tre correctes pour obtenir le point
  const topCorrect = diffTop <= TOLERANCE_MM;
  const centerCorrect = diffCenter <= TOLERANCE_MM;
  const bottomCorrect = diffBottom <= TOLERANCE_MM;
  const TOLERANCE_M = 0.3;
  const distanceCorrect = diffDistance <= TOLERANCE_M;
  
  isCorrect = topCorrect && centerCorrect && bottomCorrect && distanceCorrect;
  
  question.userAnswerTop = userAnswerTop;
  question.userAnswerCenter = userAnswerCenter;
  question.userAnswerBottom = userAnswerBottom;
  question.userAnswerDistance = userAnswerDistance;
  question.expectedTop = expectedTop;
  question.expectedCenter = expectedCenter;
  question.expectedBottom = expectedBottom;
  question.expectedDistance = expectedDistance;
  question.topCorrect = topCorrect;
  question.centerCorrect = centerCorrect;
  question.bottomCorrect = bottomCorrect;
  question.distanceCorrect = distanceCorrect;
  
  // Pour l'affichage du feedback
  userAnswer = `H:${userAnswerTop} M:${userAnswerCenter} B:${userAnswerBottom} D:${userAnswerDistance} m`;
  expected = `H:${expectedTop} M:${expectedCenter} B:${expectedBottom} D:${expectedDistance} m`;
  
  question.answered = true;
  question.correct = isCorrect;
  
  if (isCorrect) {
    score++;
  }
  
  // Afficher le feedback
  const feedback = document.getElementById('feedback');
  feedback.style.display = 'block';
  
  // Feedback identique pour tous les exercices
  if (isCorrect) {
    feedback.className = 'feedback correct';
    feedback.textContent = `‚úì Correct ! Toutes les lectures sont justes.`;
  } else {
    feedback.className = 'feedback incorrect';
    let details = [];
    if (!question.topCorrect) details.push(`Haut: ${question.expectedTop} mm (votre r√©ponse: ${question.userAnswerTop} mm)`);
    if (!question.centerCorrect) details.push(`Milieu: ${question.expectedCenter} mm (votre r√©ponse: ${question.userAnswerCenter} mm)`);
    if (!question.bottomCorrect) details.push(`Bas: ${question.expectedBottom} mm (votre r√©ponse: ${question.userAnswerBottom} mm)`);
    if (!question.distanceCorrect) details.push(`Distance: ${question.expectedDistance} m (votre r√©ponse: ${question.userAnswerDistance} m)`);
    feedback.textContent = `‚úó Incorrect. ${details.join(' | ')}`;
  }
  // D√©sactiver les 4 champs
  document.getElementById('userAnswerTop').disabled = true;
  document.getElementById('userAnswerCenter').disabled = true;
  document.getElementById('userAnswerBottom').disabled = true;
  document.getElementById('userAnswerVerification').disabled = true;
  
  // Changer les boutons
  document.getElementById('btnVerify').style.display = 'none';
  document.getElementById('btnNext').style.display = 'block';
  
  updateScoreDisplay();
}

// Question suivante
function nextQuestion() {
  currentQuestion++;
  showQuestion();
}

// Afficher le score
function updateScoreDisplay() {
  const answered = questions.filter(q => q.answered).length;
  document.getElementById('scoreDisplay').textContent = `Score: ${score}/${answered}`;
}

// Afficher le score final
function showFinalScore() {
  document.getElementById('exerciseContent').style.display = 'none';
  document.getElementById('finalScore').style.display = 'block';
  document.getElementById('btnRestart').style.display = 'none'; // Masqu√© au d√©part
  
  const percentage = Math.round((score / TOTAL_QUESTIONS) * 100);
  document.getElementById('finalPercentage').textContent = `${percentage}%`;
  
  let message = '';
  if (percentage >= 90) {
    message = 'üèÜ Excellent ! Vous ma√Ætrisez parfaitement la lecture des mires !';
    document.getElementById('finalPercentage').style.color = '#4CAF50';
  } else if (percentage >= 70) {
    message = 'üëç Tr√®s bien ! Continuez √† vous entra√Æner pour atteindre l\'excellence.';
    document.getElementById('finalPercentage').style.color = '#2196F3';
  } else if (percentage >= 50) {
    message = 'üìö Bien ! Avec un peu plus de pratique, vous allez progresser.';
    document.getElementById('finalPercentage').style.color = '#ff9800';
  } else {
    message = 'üí™ Continuez √† vous entra√Æner, la pratique est la cl√© du succ√®s !';
    document.getElementById('finalPercentage').style.color = '#f44336';
  }
  
  document.getElementById('finalMessage').textContent = message;
  document.getElementById('finalMessage').style.fontSize = '14px';
  document.getElementById('finalMessage').style.marginTop = '15px';
  
  // Afficher un message d'attente
  const finalMessageDiv = document.getElementById('finalMessage');
  finalMessageDiv.innerHTML = message + '<br><br><span style="color:#ff6600;font-weight:bold;">‚è≥ Envoi des r√©sultats en cours...</span>';
  
  // Envoyer les r√©sultats √† Google Sheets
  sendResultsToSheet(percentage);
}

// Fonction pour envoyer les r√©sultats √† Google Sheets
function sendResultsToSheet(percentage) {
  // R√©cup√©rer la date et l'heure actuelles
  const now = new Date();
  const date = now.toLocaleDateString('fr-FR');
  const heure = now.toLocaleTimeString('fr-FR');
  
  const data = {
    nom: candidateName,
    date: date,
    heure: heure,
    note: score + ' / ' + TOTAL_QUESTIONS,
    pourcentage: percentage + '%',
    exercice: currentExerciseType
  };
  
  console.log('Envoi vers Google Sheets:', data);
  
  // URL du Google Apps Script configur√©e - VERSION 5 avec v√©rification √©valuation
  // ID de feuille Google Sheets: 1x61hVIXCvbnket9bknTAfl6GUVP7gJ0GugIg_pgeRbY
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyujQdTB7YO_lEdMmhkfsivNgq-2ktSX3Jtf65zbBPKyiM5x1SaGoDqUgaenNjrY0djzQ/exec';
  
  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    console.log('R√©sultats envoy√©s:', res);
    // Afficher le message de succ√®s
    const finalMessageDiv = document.getElementById('finalMessage');
    const currentMessage = finalMessageDiv.innerHTML.split('<br>')[0];
    finalMessageDiv.innerHTML = currentMessage + '<br><br><span style="color:#4CAF50;font-weight:bold;">‚úÖ R√©sultats enregistr√©s avec succ√®s !</span>';
    // Afficher le bouton Nouvelle √©valuation
    document.getElementById('btnRestart').style.display = 'block';
  })
  .catch(err => {
    console.error('Erreur lors de l\'envoi:', err);
    // Afficher le message d'erreur
    const finalMessageDiv = document.getElementById('finalMessage');
    const currentMessage = finalMessageDiv.innerHTML.split('<br>')[0];
    finalMessageDiv.innerHTML = currentMessage + '<br><br><span style="color:#f44336;font-weight:bold;">‚ùå Erreur lors de l\'enregistrement</span>';
    // Afficher quand m√™me le bouton Nouvelle √©valuation
    document.getElementById('btnRestart').style.display = 'block';
  });
}

// Recommencer l'exercice
function restartExercise() {
  showIntroPage();
}

// √âv√©nements
document.getElementById('btnVerify').addEventListener('click', verifyAnswer);
document.getElementById('btnNext').addEventListener('click', nextQuestion);
document.getElementById('btnRestart').addEventListener('click', restartExercise);
document.getElementById('btnHome').addEventListener('click', showIntroPage);

// Permettre de valider avec la touche Entr√©e
document.getElementById('userAnswer').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    if (document.getElementById('btnVerify').style.display !== 'none') {
      verifyAnswer();
    } else {
      nextQuestion();
    }
  }
});

// Bloquer le zoom navigateur (Ctrl+scroll, Ctrl+plus/moins)
document.addEventListener('wheel', (e) => {
  if (e.ctrlKey) {
    e.preventDefault();
  }
}, { passive: false });

document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')) {
    e.preventDefault();
  }
});

// Bloquer le geste de pincement sur mobile
document.addEventListener('gesturestart', (e) => {
  e.preventDefault();
});

document.addEventListener('gesturechange', (e) => {
  e.preventDefault();
});

document.addEventListener('gestureend', (e) => {
  e.preventDefault();
});

// Bloquer le menu contextuel (clic droit)
document.addEventListener('contextmenu', (e) => {
  e.preventDefault();
});

// Bloquer le double-clic qui peut zoomer sur certains navigateurs
document.addEventListener('dblclick', (e) => {
  e.preventDefault();
});
</script>

</body>

</html>
